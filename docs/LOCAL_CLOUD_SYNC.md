# Local-Cloud Interface & Synchronization

This document defines the synchronization logic, scheduling, and error handling patterns for communication between the local device and the cloud provider.

## 1. Interface Definition (`AttendanceCloudProvider`)

The application interacts with the cloud through a backend-agnostic interface. The implementation (e.g., Google Sheets) handles specific API concerns like worksheet mapping and recovery.

### Operations
*   **`fetchMasterAttendees` / `fetchMasterGroups`**: 
    *   Retrieves the full global list of attendees and their group assignments.
    *   **Usage**: Read-only pull during scheduled master sync.
*   **`fetchRecentEvents(days: Int)`**:
    *   Retrieves a list of events occurring within the specified window (e.g., last 30 days).
    *   **Usage**: Population of the Events screen and identification of cloud worksheet mappings.
*   **`pushAttendance(event: Event, records: List<AttendanceRecord>)`**:
    *   Uploads local attendance commits to the cloud.
    *   **Resolution**: Matches local `Event` to a cloud worksheet by name if `cloudEventId` is missing or invalid.
    *   **Recovery**: If a cached ID fails, attempts to find another worksheet with the same title before failing.
*   **`fetchAttendanceForEvent(event: Event)`**:
    *   Pulls current cloud state for a specific event to reconcile local data.

## 2. Event Identity & Mapping
*   **Local UUID**: Every event created on a device is assigned a unique UUID. This is used for all local relations (attendance records, queue archives).
*   **Cloud Event ID (Worksheet ID)**: The Google Sheets provider uses the `cloudEventId` to push/pull data. Multiple users (A and B) will have different local UUIDs for the same event but must map to the same Cloud Event ID.
*   **Mapping**: The sync engine matches local events to cloud worksheets by name. Once matched, the `cloudEventId` is stored locally.

## 3. Synchronization Logic

### Demo Mode
*   **Implementation**: Demo mode is implemented as a specialized `DemoCloudProvider`.
*   **Behavior**: 
    *   The app functions exactly like the real mode, but interacts with mock data generated by the provider.
    *   `SyncJob` entries are created and "pushed" to the demo provider, which handles them in memory.
    *   **Data Parity**: The demo provider generates deterministic events within the last 30 days. Reconciliation follows the standard "Last Commit Wins" logic.
*   **Transition**: Successful login replaces the `DemoCloudProvider` with the real `GoogleSheetsProvider`, clears local storage, and triggers a fresh sync.

### Authenticated Mode
*   **Master Lists Sync (Attendees, Groups)**: 
    *   **Schedule**: Pulled on application start and periodically in the background.
    *   **Inhibition**: Background pull is **paused** if any `SyncJob` is pending in the queue.
*   **Event List Sync**: 
    *   **Trigger**: Pulled whenever the **Events** screen is opened.
    *   **Managed Window**: **30 days**.
    *   **Purge**: Events and attendance records older than 30 days are purged from local storage upon opening the events screen.
*   **Attendance Pull Sync**:
    *   **Trigger**: Pulled on application start and periodically in the background for the **Active Event**.
    *   **Inhibition**: Paused if `SyncJob` queue is not empty.
*   **Attendance Push Sync**:
    *   **Trigger**: Sequential processing of `SyncJob` queue as soon as connectivity is available.
    *   **Partial Failures**: Handled at the provider level. The Google Sheets provider tracks successfully processed records in memory during a session to resume from the point of failure.
    *   **Exponential Backoff**: For retryable errors (network, 429), backoff starting at 2s up to **30s maximum**. Scheduled pulls are stalled during this backoff period.

## 4. Constraints
*   **No Renaming**: Local event names cannot be edited once created. The UI must provide a preview and confirmation before final creation.

## 5. Comprehensive Error Scenarios

| Scenario | UX Handling | System Action |
| :--- | :--- | :--- |
| **Authentication Expired** | Cloud icon shows `CloudAlert`. Dialog shows "Not Authenticated". | Pause sync queue. Attempt silent refresh; if fail, wait for user login. |
| **Worksheet Deleted** | Cloud icon shows `CloudAlert`. Error logged in Status Dialog. | Sync engine attempts recovery by finding worksheet with same name. If failed, flag job as error. |
| **Offline (No Connection)** | Cloud icon shows `CloudOff` or dot. | Queue jobs locally. WorkManager will retry once network is available. |
| **Concurrent Edit (Conflict)** | Silent resolution (Last Commit Wins). | Merge cloud state with local using synchronized NTP timestamps. |
| **Worksheet Name Changed** | Silent update. | Master sync pulls worksheet names and overwrites local event titles to maintain parity. |
| **Sheet Cell Limit Hit** | persistent SnackBar alert. | (Backend specific) Recreate sheet with UUID suffix and update mapping. |
| **API Rate Limit (429)** | Cloud icon pulses/dot. | Enter exponential backoff (up to 30s). Pause all pulls. |
| **Master Data Mismatch** | Toast: "Data mismatch, refreshing". | If a push contains an ID not in the local master list, trigger a master sync refresh. |
| **App Start Conflict** | Silent. | On start, reconcile local vs cloud timestamps for the active event. Cloud wins if newer. |
| **GSheet Workbook Access Denied** | Cloud icon `CloudAlert`. | Engine pauses. User needs to tap icon to re-auth or check spreadsheet permissions. |
| **Event > 30 Days Old** | Auto-removal from list. | Purge event and associated attendance records from local DB. |
